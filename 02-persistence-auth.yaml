AWSTemplateFormatVersion: '2010-09-09'
Description: 'Shortix Infrastructure: Persistence & Auth Stack (02-persistence-auth)'

Parameters:
  Environment:
    Type: String
    Default: prod
    Description: Environment name (e.g., dev, staging, prod)

Resources:
  # DynamoDB Table
  UrlShortenerTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: UrlShortenerTable
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
        - AttributeName: gsi1_pk
          AttributeType: S
        - AttributeName: created_at
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: UserUrlsIndex
          KeySchema:
            - AttributeName: gsi1_pk
              KeyType: HASH
            - AttributeName: created_at
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      Tags:
        - Key: Name
          Value: shortix-dynamodb-table

  # Cognito User Pool
  CognitoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: ShortixUserPool
      AutoVerifiedAttributes:
        - email
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false
          RequireUppercase: true
      EmailConfiguration:
        EmailSendingAccount: COGNITO_DEFAULT
      VerificationMessageTemplate:
        DefaultEmailOption: CONFIRM_WITH_CODE
        EmailSubject: "Shortix Verification Code"
        EmailMessage: "Your verification code is {####}. Welcome to Shortix!"

  # Cognito User Pool Client
  CognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: ShortixWebClient
      UserPoolId: !Ref CognitoUserPool
      GenerateSecret: false # SPA (React) usually needs no secret
      ExplicitAuthFlows:
        - ALLOW_USER_SRP_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH

  # S3 Artifacts Bucket
  ArtifactBucket:
    Type: AWS::S3::Bucket
    Properties:
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

  # Website Hosting Bucket
  WebsiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

  # CloudFront Origin Access Control
  CloudFrontOriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Description: 'OAC for Website Bucket'
        Name: !Sub "${AWS::StackName}-OAC"
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  # CloudFront Distribution
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Origins:
          - DomainName: !GetAtt WebsiteBucket.DomainName
            Id: WebsiteBucketOrigin
            S3OriginConfig:
              OriginAccessIdentity: "" # Using OAC instead
            OriginAccessControlId: !Ref CloudFrontOriginAccessControl
        Enabled: true
        DefaultRootObject: index.html
        DefaultCacheBehavior:
          TargetOriginId: WebsiteBucketOrigin
          ViewerProtocolPolicy: redirect-to-https
          Compress: true
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
        # SPA Routing: Redirect 404s to index.html
        CustomErrorResponses:
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
        Comment: !Sub "Distribution for ${AWS::StackName} website"

  # Bucket Policy for CloudFront OAC Access
  WebsiteBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref WebsiteBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            Resource: !Sub "arn:aws:s3:::${WebsiteBucket}/*"
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub "arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}"

  # SSM Parameters
  DynamoDBTableNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/shortix/${Environment}/persistence/table-name"
      Type: String
      Value: !Ref UrlShortenerTable

  UserPoolIdParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/shortix/${Environment}/auth/user-pool-id"
      Type: String
      Value: !Ref CognitoUserPool

  UserPoolClientIdParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/shortix/${Environment}/auth/client-id"
      Type: String
      Value: !Ref CognitoUserPoolClient

  WebsiteBucketNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/shortix/${Environment}/web/bucket-name"
      Type: String
      Value: !Ref WebsiteBucket

  ArtifactBucketNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/shortix/${Environment}/persistence/artifact-bucket-name"
      Type: String
      Value: !Ref ArtifactBucket

  CloudFrontDistributionIdParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/shortix/${Environment}/web/distribution-id"
      Type: String
      Value: !Ref CloudFrontDistribution

  CloudFrontDomainNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/shortix/${Environment}/web/domain-name"
      Type: String
      Value: !GetAtt CloudFrontDistribution.DomainName

Outputs:
  DynamoDBTableName:
    Description: Name of the DynamoDB Table
    Value: !Ref UrlShortenerTable
    Export:
      Name: !Sub "${AWS::StackName}-DynamoDBTableName"

  UserPoolId:
    Description: ID of the Cognito User Pool
    Value: !Ref CognitoUserPool
    Export:
      Name: !Sub "${AWS::StackName}-UserPoolId"

  UserPoolClientId:
    Description: ID of the Cognito User Pool Client
    Value: !Ref CognitoUserPoolClient
    Export:
      Name: !Sub "${AWS::StackName}-UserPoolClientId"

  ArtifactBucketName:
    Description: Name of the S3 Artifact Bucket
    Value: !Ref ArtifactBucket
    Export:
      Name: !Sub "${AWS::StackName}-ArtifactBucketName"

  WebsiteBucketName:
    Description: Name of the S3 Website Bucket
    Value: !Ref WebsiteBucket
    Export:
      Name: !Sub "${AWS::StackName}-WebsiteBucketName"

  CloudFrontDistributionId:
    Description: ID of the CloudFront Distribution
    Value: !Ref CloudFrontDistribution
    Export:
      Name: !Sub "${AWS::StackName}-CloudFrontDistributionId"

  CloudFrontDomainName:
    Description: Domain name of the CloudFront Distribution
    Value: !GetAtt CloudFrontDistribution.DomainName
    Export:
      Name: !Sub "${AWS::StackName}-CloudFrontDomainName"
