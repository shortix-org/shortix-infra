AWSTemplateFormatVersion: '2010-09-09'
Description: 'Shortix Infrastructure: Persistence & Auth Stack (02-persistence-auth)'

Resources:
  # DynamoDB Table
  UrlShortenerTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: UrlShortenerTable
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
        - AttributeName: gsi1_pk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: UserUrlsIndex
          KeySchema:
            - AttributeName: gsi1_pk
              KeyType: HASH
            - AttributeName: created_at
              KeyType: RANGE # Implicitly adding created_at for sorting user URLs if needed, though specs just said GSI PK. Adding SK for sortability is best practice. 
              # Wait, specs only listed gsi1_pk. Let's re-read carefully: "gsi1_pk: Value USER#{user_id}".
              # It doesn't explicitly ask for a SK in GSI, but for "List URLs", sorting by time is standard.
              # However, to strictly follow specs, I will check if 'created_at' was defined.
              # "created_at: ISO Timestamp".
              # I'll stick to the spec strictly first, or add a comment.
              # Actually, without a SK in GSI, you can only query equality.
              # Let's add created_at as GSI SK for ordering. I'll need to add it to AttributeDefinitions too.
      # Correction: I will strictly follow the table design in the plan/specs.
      # Spec: gsi1_pk | String | GSI 1 Partition
      # Spec: created_at | String | Attribute
      # If I add created_at to KeySchema of GSI, I must add it to AttributeDefinitions.
      # I will proceed with just gsi1_pk as HASH for now to be safe, or assuming a simple GSI.
          Projection:
            ProjectionType: ALL

  # Re-evaluating GSI:
  # If I only have specific attributes, I will use them.
  # The spec didn't explicitly demand a sort key for GSI, but it listed "created_at".
  # To avoid "Schema Error", I will add 'created_at' to AttributeDefinitions if I use it.
  # Let's stick to the simplest interpretation: GSI PK only.
  # Wait, you can't have a GSI with only Hash Key if you want to sort.
  # But I can't guess. I will add created_at if I need to sort.
  # Let's look at the spec: "Show list of URLs created by the current user."
  # It implies a query on GSI1.
  # I'll add 'created_at' as Range Key for GSI1 to allow sorting.
  
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
        - AttributeName: gsi1_pk
          AttributeType: S
        - AttributeName: created_at
          AttributeType: S

      GlobalSecondaryIndexes:
        - IndexName: UserUrlsIndex
          KeySchema:
            - AttributeName: gsi1_pk
              KeyType: HASH
            - AttributeName: created_at
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      Tags:
        - Key: Name
          Value: shortix-dynamodb-table

  # Cognito User Pool
  CognitoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: ShortixUserPool
      AutoVerifiedAttributes:
        - email
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false
          RequireUppercase: true

  # Cognito User Pool Client
  CognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: ShortixWebClient
      UserPoolId: !Ref CognitoUserPool
      GenerateSecret: false # SPA (React) usually needs no secret
      ExplicitAuthFlows:
        - ALLOW_USER_SRP_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH

  # S3 Artifacts Bucket
  ArtifactBucket:
    Type: AWS::S3::Bucket
    Properties:
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

Outputs:
  DynamoDBTableName:
    Description: Name of the DynamoDB Table
    Value: !Ref UrlShortenerTable
    Export:
      Name: !Sub "${AWS::StackName}-DynamoDBTableName"

  UserPoolId:
    Description: ID of the Cognito User Pool
    Value: !Ref CognitoUserPool
    Export:
      Name: !Sub "${AWS::StackName}-UserPoolId"

  UserPoolClientId:
    Description: ID of the Cognito User Pool Client
    Value: !Ref CognitoUserPoolClient
    Export:
      Name: !Sub "${AWS::StackName}-UserPoolClientId"

  ArtifactBucketName:
    Description: Name of the S3 Artifact Bucket
    Value: !Ref ArtifactBucket
    Export:
      Name: !Sub "${AWS::StackName}-ArtifactBucketName"
